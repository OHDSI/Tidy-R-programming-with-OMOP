# Creating a reference to the OMOP common data model

## Connecting to a database from R using DBI

Database connections from R can be made using the [DBI package](https://dbi.r-dbi.org/). The back-end for `DBI` is facilitated by database specific driver packages. As an example, lets say we want to work with a local duckdb from R. In this case the we can use the duckdb R package as the driver.

```{r}
library(DBI)
db<-dbConnect(duckdb::duckdb(), dbdir=":memory:")
```

If we instead wanted to connect to other database management systems, these connections would be supported by the associated back-end packages and could look something like the below example for Postgres:

```{r, eval=FALSE}
# Postgres
db <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = Sys.getenv("CDM5_POSTGRESQL_DBNAME"),
                      host = Sys.getenv("CDM5_POSTGRESQL_HOST"),
                      user = Sys.getenv("CDM5_POSTGRESQL_USER"),
                      password = Sys.getenv("CDM5_POSTGRESQL_PASSWORD"))
```

## Creating a reference to the OMOP common data model

As seen in the previous chapter, once a connection to the database has been created we could then create references to the various tables in the database and build queries using in a familiar dplyr style. However, as we already know what the structure of the OMOP CDM looks like, we can avoid the overhead of creating references to the OMOP CDM tables by using the `CDMConnector` package to quickly create a reference to the database as a whole.

If you don't already have it installed, the first step would be to install `CDMConnector` from CRAN.

```{r, eval=FALSE}
install.packages("CDMConnector")
```

For this example, we'll use the Eunomia example data contained in a duckdb database. First we need to download the data. And once downloaded, make sure to add the path to your Renviron.

```{r, echo = TRUE, warning=FALSE, message=FALSE}
library(CDMConnector)
```

```{r, eval = FALSE}
# change pathToData to the location you want to save the data
CDMConnector::downloadEunomiaData(
  pathToData = here::here(), 
  overwrite = TRUE
)
# once downloaded, save your pathToData to your Renviron (and then restart R)
# EUNOMIA_DATA_FOLDER="......"
```

```{r, echo = TRUE}
db <- DBI::dbConnect(duckdb::duckdb(), 
                     dbdir = CDMConnector::eunomia_dir())
cdm <- CDMConnector::cdm_from_con(con = db, 
                                  cdm_schema = "main")
cdm
```

Once we have created the our reference to the overall OMOP CDM, we can reference specific tables using the "\$" operator.

```{r, echo = TRUE}
cdm$observation_period
```

Alternatively, you could also access a specific table reference like so

```{r, echo = TRUE}
cdm[["observation_period"]]
```

When we created our reference we could have also specified a subset of cdm tables that we want to reference to:

```{r, echo = TRUE}
cdm <- cdm_from_con(db, 
                    cdm_tables = c("person","observation_period"))
cdm
```

Moreover, we can also specify a write schema. This would be a schema in which we have permission to create tables (as we're unlikely to have that permission for the schema containing the tables with the patient-level data).

```{r, echo = TRUE, eval = FALSE}
cdm <- cdm_from_con(db,
  cdm_schema = "main",
  cdm_tables = c("person","observation_period"),
  write_schema = "results")
```

And if we already had some cohort tables in the results schema, we could include references to these like so:

```{r, echo = TRUE, eval = FALSE}
cdm <- cdm_from_con(db,
  cdm_schema = "main",
  cdm_tables = c("person","observation_period"),
  write_schema = "results",
  cohort_tables = c("exposure_cohort", "outcome_cohort"))
```

## Database snapshot

We can also use `CDMConnector` to provide a summary of the metadata for the OMOP CDM data we have connected to using the `snapshot()` function.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
```

```{r}
cdm_from_con(con = db, 
             cdm_schema = "main") %>% 
  snapshot() %>% 
  glimpse()
```

## Further reading

-   [CDMConnector package](https://darwin-eu.github.io/CDMConnector)
