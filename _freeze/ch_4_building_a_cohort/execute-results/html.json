{
  "hash": "8a7117f4fa450fdf7dd92076690b049f",
  "result": {
    "markdown": "# Adding cohorts to the CDM\n\n## Cohort definitions\n\nWhen performing research with the OMOP common data model we often want to identify groups of individuals who share some set of characteristics. The criteria for including individuals can range from the seemingly simple (e.g. people diagnosed with asthma) to the much more complicated (e.g. adults diagnosed with asthma who had a year of prior observation time in the database prior to their diagnosis, had no prior history of chronic obstructive pulmonary disease, and no history of use of short-acting beta-agonists). The set of people we identify are cohorts, and the OMOP CDM has a specific structure by which they can be represented, with a cohort table having four required fields: cohort_definition_id (a unique identifier for each cohort), subject_id (a foreign key to the subject in the cohort - typically referring to records in the person table), cohort_start_date, and cohort_end_date.\n\nCohorts can be defined using entirely bespoke code (so long as the output fits the cohort table specification). However because cohort definitions often follow a similar logic, tools have also be developed to facilitate cohort creation. In particular, [ATLAS](https://atlas-demo.ohdsi.org) provides a graphical user interface which can be used to create cohort definitions that are expressed as JSON which can subsequently be rendered to SQL. The Capr R package, used below, provides a means of definining the JSON via R code instead.\n\n## Defining cohorts programmatically\n\nWe can define a cohort programmatically using the Capr package. In addition we the CodelistGenerator package can be used to help find the codes to use in our cohort definitions.\n\nLet´s load the required packages and connect to the Eunomia data again.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(CDMConnector)\nlibrary(dplyr)\nlibrary(Capr)\nlibrary(CodelistGenerator)\n\ncon <- DBI::dbConnect(duckdb::duckdb(), eunomia_dir())\n\ncdm <- CDMConnector::cdm_from_con(\n  con = con,\n  cdm_schema = \"main\",\n  write_schema = \"main\"\n)\n```\n:::\n\n\nSay we want to create a cohort of people with a gastrointestinal hemorrhage. We´ll start by getting the code that represents \"gastrointestinal hemorrhage\" \n\n\n::: {.cell}\n\n```{.r .cell-code}\ngibleed_codes <- getCandidateCodes(cdm = cdm, \n                  keywords = \"gastrointestinal hemorrhage\",\n                  domains = \"condition\",\n                  exactMatch = TRUE,\n                  includeDescendants = FALSE)\ngibleed_codes %>% \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 1\nColumns: 6\n$ concept_id       <dbl> 192671\n$ concept_name     <chr> \"Gastrointestinal hemorrhage\"\n$ domain_id        <chr> \"condition\"\n$ concept_class_id <chr> \"clinical finding\"\n$ vocabulary_id    <chr> \"snomed\"\n$ found_from       <chr> \"From initial search\"\n```\n:::\n\n```{.r .cell-code}\ngibleed_concept_set <- cs(descendants(gibleed_codes$concept_id))\n```\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n## Finding appropriate codes\nThe above gives the impression that identifying concepts that represent a particular clinical idea is straightforward. In practice, however, this is rarely the case. Identifying the codes that could represent a condition and then choosing which does though is typically a time consuming task .....\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngetCandidateCodes(cdm = cdm, \n                  keywords = \"fracture\",\n                  domains = \"condition\",\n                  includeDescendants = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 6\n  concept_id concept_name                        domai…¹ conce…² vocab…³ found…⁴\n       <dbl> <chr>                               <chr>   <chr>   <chr>   <chr>  \n1    4048695 Fracture of vertebral column witho… condit… clinic… snomed  From i…\n2    4142905 Fracture of rib                     condit… clinic… snomed  From i…\n3    4278672 Fracture of forearm                 condit… clinic… snomed  From i…\n4    4237458 Fracture of clavicle                condit… clinic… snomed  From i…\n5    4230399 Closed fracture of hip              condit… clinic… snomed  From i…\n6   40480160 Pathological fracture due to osteo… condit… clinic… snomed  From i…\n7    4066995 Fracture of vertebral column with … condit… clinic… snomed  From i…\n8    4059173 Fracture of ankle                   condit… clinic… snomed  From i…\n9    4134304 Fracture subluxation of wrist       condit… clinic… snomed  From i…\n# … with abbreviated variable names ¹​domain_id, ²​concept_class_id,\n#   ³​vocabulary_id, ⁴​found_from\n```\n:::\n:::\n\n\n:::\n\n\nOnce we´ve identified our codes we´ll create a concept set that includes this code or any of its descendants.\n\n::: {.cell}\n\n```{.r .cell-code}\ngibleed_concept_set <- cs(descendants(gibleed_codes$concept_id))\n```\n:::\n\n\nWe can now use this concept set in a cohort definition. We´ll look for anyone with a correspong record in the condition occurrence table. We´ll also require that this is their first such record.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nentry_criteria <- entry(\n    condition(gibleed_concept_set),\n    primaryCriteriaLimit = \"First\"\n  )\n\ngibleed_cohort_definition <- cohort(entry = entry_criteria)\n```\n:::\n\n\nWe could though make things a little more complicated. What if we wanted to exclude anyone with rheumatoid arthritis (regardless of when they were diagnosed). To do this we´ll first need to create another concept set, this time for rheumatoid arthritis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrheumatoid_arthritis_codes <- getCandidateCodes(cdm = cdm, \n                  keywords = \"rheumatoid arthritis\",\n                  domains = \"condition\",\n                  exactMatch = TRUE,\n                  includeDescendants = FALSE)\nrheumatoid_arthritis_codes %>% \n  glimpse()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 1\nColumns: 6\n$ concept_id       <dbl> 80809\n$ concept_name     <chr> \"Rheumatoid arthritis\"\n$ domain_id        <chr> \"condition\"\n$ concept_class_id <chr> \"clinical finding\"\n$ vocabulary_id    <chr> \"snomed\"\n$ found_from       <chr> \"From initial search\"\n```\n:::\n\n```{.r .cell-code}\nrheumatoid_arthritis_concept_set <- cs(descendants(\n  rheumatoid_arthritis_codes$concept_id))\n```\n:::\n\n\n::: {.callout-tip collapse=\"true\"}\n## JSON representation of a concept set\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(as.json(gibleed_concept_set))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{\n  \"items\": [\n    {\n      \"concept\": {\n        \"CONCEPT_ID\": 192671,\n        \"CONCEPT_NAME\": \"\",\n        \"STANDARD_CONCEPT\": \"\",\n        \"STANDARD_CONCEPT_CAPTION\": \"\",\n        \"INVALID_REASON\": \"\",\n        \"INVALID_REASON_CAPTION\": \"\",\n        \"CONCEPT_CODE\": \"\",\n        \"DOMAIN_ID\": \"\",\n        \"VOCABULARY_ID\": \"\",\n        \"CONCEPT_CLASS_ID\": \"\"\n      },\n      \"isExcluded\": false,\n      \"includeDescendants\": true,\n      \"includeMapped\": false\n    }\n  ]\n}\n```\n:::\n\n```{.r .cell-code}\ncat(as.json(rheumatoid_arthritis_concept_set))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{\n  \"items\": [\n    {\n      \"concept\": {\n        \"CONCEPT_ID\": 80809,\n        \"CONCEPT_NAME\": \"\",\n        \"STANDARD_CONCEPT\": \"\",\n        \"STANDARD_CONCEPT_CAPTION\": \"\",\n        \"INVALID_REASON\": \"\",\n        \"INVALID_REASON_CAPTION\": \"\",\n        \"CONCEPT_CODE\": \"\",\n        \"DOMAIN_ID\": \"\",\n        \"VOCABULARY_ID\": \"\",\n        \"CONCEPT_CLASS_ID\": \"\"\n      },\n      \"isExcluded\": false,\n      \"includeDescendants\": true,\n      \"includeMapped\": false\n    }\n  ]\n}\n```\n:::\n:::\n\n:::\n\nAnd now we can add this excluision criteria to our cohort definition.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngibleed_no_RA_cohort_definition <- cohort(\n   entry = entry(\n    condition(gibleed_concept_set),\n    primaryCriteriaLimit = \"First\"\n  ),\n  attrition = attrition(\n    \"no RA\" = withAll(\n      exactly(0,\n              condition(rheumatoid_arthritis_concept_set),\n              duringInterval(eventStarts(-Inf, Inf))))\n  ))\n\n\n\n\npath <- file.path(tempdir(), \"cohorts\")\ndir.create(path)\nwriteCohort(gibleed_cohort_definition, file.path(path, \"gibleed.json\"))\ngibleed_cohort_set <- readCohortSet(path = path)\n\n\n\n# cdm <- generateCohortSet(\n#   cdm,\n#   gibleed_cohort_set,\n#   name = \"gibleed\",\n#   computeAttrition = TRUE\n# )\n```\n:::\n\n\n\n::: {.callout-tip collapse=\"true\"}\n## JSON representation of a cohort\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(as.json((gibleed_cohort_definition)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{\n  \"ConceptSets\": [\n    {\n      \"id\": 0,\n      \"name\": \"\",\n      \"expression\": {\n        \"items\": [\n          {\n            \"concept\": {\n              \"CONCEPT_ID\": 192671,\n              \"CONCEPT_NAME\": \"\",\n              \"STANDARD_CONCEPT\": \"\",\n              \"STANDARD_CONCEPT_CAPTION\": \"\",\n              \"INVALID_REASON\": \"\",\n              \"INVALID_REASON_CAPTION\": \"\",\n              \"CONCEPT_CODE\": \"\",\n              \"DOMAIN_ID\": \"\",\n              \"VOCABULARY_ID\": \"\",\n              \"CONCEPT_CLASS_ID\": \"\"\n            },\n            \"isExcluded\": false,\n            \"includeDescendants\": true,\n            \"includeMapped\": false\n          }\n        ]\n      }\n    }\n  ],\n  \"PrimaryCriteria\": {\n    \"CriteriaList\": [\n      {\n        \"ConditionOccurrence\": {\n          \"CodesetId\": 0\n        }\n      }\n    ],\n    \"ObservationWindow\": {\n      \"PriorDays\": 0,\n      \"PostDays\": 0\n    },\n    \"PrimaryCriteriaLimit\": {\n      \"Type\": \"First\"\n    }\n  },\n  \"QualifiedLimit\": {\n    \"Type\": \"First\"\n  },\n  \"ExpressionLimit\": {\n    \"Type\": \"First\"\n  },\n  \"InclusionRules\": [],\n  \"CensoringCriteria\": [],\n  \"CollapseSettings\": {\n    \"CollapseType\": \"ERA\",\n    \"EraPad\": 0\n  },\n  \"CensorWindow\": {},\n  \"cdmVersionRange\": \">=5.0.0\"\n}\n```\n:::\n\n```{.r .cell-code}\ncat(as.json((gibleed_no_RA_cohort_definition)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n{\n  \"ConceptSets\": [\n    {\n      \"id\": 0,\n      \"name\": \"\",\n      \"expression\": {\n        \"items\": [\n          {\n            \"concept\": {\n              \"CONCEPT_ID\": 192671,\n              \"CONCEPT_NAME\": \"\",\n              \"STANDARD_CONCEPT\": \"\",\n              \"STANDARD_CONCEPT_CAPTION\": \"\",\n              \"INVALID_REASON\": \"\",\n              \"INVALID_REASON_CAPTION\": \"\",\n              \"CONCEPT_CODE\": \"\",\n              \"DOMAIN_ID\": \"\",\n              \"VOCABULARY_ID\": \"\",\n              \"CONCEPT_CLASS_ID\": \"\"\n            },\n            \"isExcluded\": false,\n            \"includeDescendants\": true,\n            \"includeMapped\": false\n          }\n        ]\n      }\n    },\n    {\n      \"id\": 1,\n      \"name\": \"\",\n      \"expression\": {\n        \"items\": [\n          {\n            \"concept\": {\n              \"CONCEPT_ID\": 80809,\n              \"CONCEPT_NAME\": \"\",\n              \"STANDARD_CONCEPT\": \"\",\n              \"STANDARD_CONCEPT_CAPTION\": \"\",\n              \"INVALID_REASON\": \"\",\n              \"INVALID_REASON_CAPTION\": \"\",\n              \"CONCEPT_CODE\": \"\",\n              \"DOMAIN_ID\": \"\",\n              \"VOCABULARY_ID\": \"\",\n              \"CONCEPT_CLASS_ID\": \"\"\n            },\n            \"isExcluded\": false,\n            \"includeDescendants\": true,\n            \"includeMapped\": false\n          }\n        ]\n      }\n    }\n  ],\n  \"PrimaryCriteria\": {\n    \"CriteriaList\": [\n      {\n        \"ConditionOccurrence\": {\n          \"CodesetId\": 0\n        }\n      }\n    ],\n    \"ObservationWindow\": {\n      \"PriorDays\": 0,\n      \"PostDays\": 0\n    },\n    \"PrimaryCriteriaLimit\": {\n      \"Type\": \"First\"\n    }\n  },\n  \"QualifiedLimit\": {\n    \"Type\": \"First\"\n  },\n  \"ExpressionLimit\": {\n    \"Type\": \"First\"\n  },\n  \"InclusionRules\": [\n    {\n      \"name\": \"no RA\",\n      \"expression\": {\n        \"Type\": \"ALL\",\n        \"CriteriaList\": [\n          {\n            \"Criteria\": {\n              \"ConditionOccurrence\": {\n                \"CodesetId\": 1\n              }\n            },\n            \"StartWindow\": {\n              \"Start\": {\n                \"Coeff\": -1\n              },\n              \"End\": {\n                \"Coeff\": 1\n              },\n              \"UseIndexEnd\": false,\n              \"UseEventEnd\": false\n            },\n            \"Occurrence\": {\n              \"Type\": 0,\n              \"Count\": 0\n            }\n          }\n        ],\n        \"DemographicCriteriaList\": [],\n        \"Groups\": []\n      }\n    }\n  ],\n  \"CensoringCriteria\": [],\n  \"CollapseSettings\": {\n    \"CollapseType\": \"ERA\",\n    \"EraPad\": 0\n  },\n  \"CensorWindow\": {},\n  \"cdmVersionRange\": \">=5.0.0\"\n}\n```\n:::\n:::\n\n:::\n\n## Adding a cohort to the CDM\n\nvia cdm connector\n\n## Cohort summary\n\nAttributes: Cohort count, settings, attrition .....\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}